import { useState, useEffect, useId } from 'react';
import { useTheme } from '../../hooks/useTheme';

const mermaidPromise = import('mermaid').then((m) => m.default);

interface MermaidDiagramProps {
  code: string;
}

export function MermaidDiagram({ code }: MermaidDiagramProps) {
  const { isDark } = useTheme();
  const rawId = useId();
  const id = 'mermaid-' + rawId.replace(/:/g, '');
  const [svg, setSvg] = useState<string | null>(null);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    let cancelled = false;

    (async () => {
      try {
        const mermaid = await mermaidPromise;
        mermaid.initialize({
          startOnLoad: false,
          theme: 'base',
          fontFamily: 'inherit',
          themeVariables: isDark
            ? {
                background: 'transparent',
                primaryColor: '#312e81',
                primaryTextColor: '#e2e8f0',
                primaryBorderColor: '#6366f1',
                lineColor: '#6366f1',
                secondaryColor: '#1e293b',
                tertiaryColor: '#1e1b4b',
                noteBkgColor: '#1e293b',
                noteTextColor: '#cbd5e1',
                noteBorderColor: '#334155',
                textColor: '#e2e8f0',
                titleColor: '#e2e8f0',
                edgeLabelBackground: '#1e293b',
                classText: '#e2e8f0',
                relationColor: '#818cf8',
                labelTextColor: '#cbd5e1',
              }
            : {
                background: 'transparent',
                primaryColor: '#e0e7ff',
                primaryTextColor: '#1e293b',
                primaryBorderColor: '#6366f1',
                lineColor: '#6366f1',
                secondaryColor: '#f1f5f9',
                tertiaryColor: '#eef2ff',
                noteBkgColor: '#f1f5f9',
                noteTextColor: '#334155',
                noteBorderColor: '#cbd5e1',
                textColor: '#1e293b',
                titleColor: '#1e293b',
                edgeLabelBackground: '#f1f5f9',
                classText: '#1e293b',
                relationColor: '#4f46e5',
                labelTextColor: '#475569',
              },
        });

        const container = document.createElement('div');
        container.style.position = 'absolute';
        container.style.left = '-9999px';
        document.body.appendChild(container);

        try {
          const { svg: rendered } = await mermaid.render(id, code, container);
          if (!cancelled) {
            setSvg(rendered);
            setError(null);
          }
        } finally {
          container.remove();
        }
      } catch (e) {
        if (!cancelled) {
          setError(e instanceof Error ? e.message : String(e));
          setSvg(null);
        }
      }
    })();

    return () => {
      cancelled = true;
    };
  }, [code, isDark, id]);

  if (error) {
    return (
      <div className="mb-4 rounded-lg overflow-hidden border border-red-300 dark:border-red-700">
        <div className="px-3 py-1.5 text-xs text-red-600 dark:text-red-400 bg-red-50 dark:bg-red-900/30 border-b border-red-300 dark:border-red-700">
          Mermaid render error: {error}
        </div>
        <pre className="p-4 text-sm bg-slate-50 dark:bg-slate-800 overflow-x-auto">
          <code>{code}</code>
        </pre>
      </div>
    );
  }

  if (!svg) {
    return (
      <div className="mb-4 flex items-center justify-center p-8 rounded-lg bg-slate-50 dark:bg-slate-800 text-slate-400 dark:text-slate-500">
        <svg className="animate-spin h-5 w-5 mr-2" viewBox="0 0 24 24" fill="none">
          <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" />
          <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z" />
        </svg>
        Rendering diagram...
      </div>
    );
  }

  // SVG is generated by mermaid's rendering engine from controlled markdown source
  return (
    <div
      className="mb-4 flex justify-center p-4 rounded-lg bg-slate-50 dark:bg-slate-800 overflow-x-auto [&_svg]:max-w-full"
      dangerouslySetInnerHTML={{ __html: svg }}
    />
  );
}
